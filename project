#!/bin/bash

version() {
    echo `node -e 'console.log(require("./package.json").version)'`
}

case $1 in
    version )
        shift

        version $@
        ;;

    lint )
        make lint
        ;;

    debug )
        ./node_modules/.bin/vue-cli-service electron:serve
        ;;

    build )
        VERSION=$(./project version)

        if [[ "|$(command -v apt-get)|" != "||" ]]; then
            sudo apt-get install -y sshpass > /dev/null 2>&1
        fi

        if [[ "$OSTYPE" == "darwin"* ]]; then
            security unlock-keychain $@ login.keychain
            make desktop
        else
            mkdir -p builds

            if [ -f ../.env ]; then
                . ../.env
            fi

            mkdir -p ~/.ssh > /dev/null 2>&1
            touch ~/.ssh/known_hosts > /dev/null 2>&1

            ssh-keygen -R $DARWIN_HOST > /dev/null 2>&1
            ssh-keyscan $DARWIN_HOST >> ~/.ssh/known_hosts > /dev/null 2>&1
            rm -f ~/.ssh/known_hosts.old > /dev/null 2>&1

            sshpass -p '$DARWIN_PASSWD' -e ssh $DARWIN_USER@$DARWIN_HOST cd $PROJECT_PATH/desktop && ./project build -p '$DARWIN_PASSWD'
            sshpass -p '$DARWIN_PASSWD' -e scp $DARWIN_USER@$DARWIN_HOST:$PROJECT_PATH/desktop/builds/hoobs-desktop-v$VERSION.* ./builds/
        fi

        ;;

    clean )
        make clean
        ;;
esac
